## Codebase Patterns

### Code Structure
- Follow DRY principle: Extract reusable functions to utils/, hooks to hooks/
- Single responsibility: Each file serves one purpose
- Pure functions for business logic in utils/ (not hooks)
- React hooks only in hooks/ directory or components

### State Management
- Use Zustand stores in stores/ directory
- Store names: pageStore, editorStore, navigationStore, uiStore
- Access store state with selectors: `useStore((state) => state.property)`

### Styling
- Glass morphism: Use CSS variables from styles/variables.css
- Shadows: --shadow-small, --shadow-medium, --shadow-big
- Glass background: --glass-bg-light, --glass-bg-dark
- Glass border: --glass-border-light, --glass-border-dark
- Backdrop filter: --glass-backdrop-filter

### Components
- GlassButton variants: default, primary, danger, yellow, unstyled, active
- For delete actions: Use GlassButton with variant="danger"
- For header buttons: Use GlassButton with variant="unstyled"

### Keyboard Shortcuts
- Use useKeyboardShortcuts hook from utils/keyboardShortcuts.ts
- Use capture phase for browser conflict prevention
- Platform-aware: "cmd+n" works on both Mac and Windows
- Don't duplicate shortcuts for cmd/ctrl - hook handles it automatically

### Storage
- Use IndexedDB via utils/storage.ts
- Functions: savePage(), getAllPages(), deletePage()
- Load on mount with loadPagesFromStorage() in app/page.tsx
- Hybrid approach: IndexedDB for persistence + markdown export on demand

### Navigation
- Views: 'list' | 'editor' in navigationStore
- Use setView(view, noteId) to navigate
- Use goBack() to return to list view
- Always save current note before navigation

### Date Grouping
- Use groupPagesByDate() from utils/dateGrouping.ts
- Groups: Today, Yesterday, Previous 7 Days, Previous 30 Days, Older

### Search Highlighting
- Use highlightText() from utils/highlightText.tsx
- Returns React nodes with <span class="search-highlight">
- Styles in styles/utilities.css (yellow shadow, not block background)

### Block Editor Architecture (NEW)
- **Single Source of Truth**: config/blockMenuConfig.ts drives both slash menu and bottom bar
- **Block Types**: paragraph, heading (h1-h6), code, image, list, quote, table, divider
- **Block Structure**: { id, type, content, formats?, props?, indent? }
- **Formats Array**: Inline formatting stored as { type, start, end, data? }
- **useBlockEditor Hook**: Adapted from NewPage-main, integrates with editorStore
- **EditableBlock**: Base component for all text-editable blocks (contentEditable)
- **CustomCaret**: Blue glow caret positioned at cursor, native caret hidden

### Menu Config Pattern (NEW)
- All menu items defined in config/blockMenuConfig.ts
- Each item: { id, label, icon, category, slashCommands[], shortcut?, showInSlashMenu?, showInBottomBar? }
- Categories: 'blocks' (insertable) and 'format' (text formatting)
- Conditional functions receive selection state to determine visibility
- SlashMenu: Absolute positioned at cursor, glass styling, no overlay
- BottomBar: Contextual based on selection (blocks / formatting / block actions)

### Selection States (NEW)
- 'none': No selection, show block insertion buttons
- 'caret': Cursor in text block, show block insertion buttons
- 'text': Text range selected, show formatting buttons
- 'block': Entire block selected, show block action buttons

---

## 2024-01-29 - US-001 Glass morphism design system
- What was implemented: CSS variables for glass backgrounds, borders, and shadows
- Files changed:
  - styles/variables.css (added glass and shadow variables)
  - app/page.css (applied glass to desktop-container)
  - components/layout/AppWindow/AppWindow.css (applied glass to app-window-main)
- **Learnings for future iterations:**
  - Glass background uses rgba with low opacity (0.1)
  - Inset shadow creates the inner glow effect
  - Backdrop-filter needs both blur and saturate for Apple-like glass
---

## 2024-01-29 - US-002 GlassButton component with variants
- What was implemented: GlassButton component with 6 variants
- Files changed:
  - components/ui/GlassButton/GlassButton.tsx (added variants)
  - components/ui/GlassButton/GlassButton.css (variant styles)
- **Learnings for future iterations:**
  - For colored variants (primary, danger, yellow), only change opacity on hover
  - Use :not() selectors to exclude colored variants from default hover
  - Unstyled variant: transparent background, light grey hover
---

## 2024-01-29 - US-003 AppWindow layout with three-section header
- What was implemented: CSS Grid header with left/middle/right sections
- Files changed:
  - components/layout/AppWindow/AppWindow.tsx (restructured header)
  - components/layout/AppWindow/AppWindow.css (grid layout)
- **Learnings for future iterations:**
  - Use CSS Grid with `grid-template-columns: auto 1fr auto` for header
  - Middle section (title) should always be visible for layout stability
  - Conditional buttons: check isFileOpen before rendering
---

## 2024-01-29 - US-004 Collapsible sidebar with date grouping
- What was implemented: Sidebar with collapse, date groups, mobile hiding
- Files changed:
  - components/layout/Sidebar/CollapsibleSidebar.tsx
  - components/layout/Sidebar/CollapsibleSidebar.css
  - utils/dateGrouping.ts
- **Learnings for future iterations:**
  - On mobile (<768px): Hide sidebar completely, don't just collapse
  - Group titles should NOT be uppercase (user preference)
  - Place "New note" button next to group title, not in header
---

## 2024-01-29 - US-005 Note CRUD with IndexedDB storage
- What was implemented: Full CRUD operations with IndexedDB persistence
- Files changed:
  - utils/storage.ts (IndexedDB operations)
  - stores/pageStore.ts (integrated storage)
  - app/page.tsx (load on mount)
- **Learnings for future iterations:**
  - Use idb library for IndexedDB wrapper
  - Always sort pages by updatedAt descending after loading
  - Save asynchronously, don't block UI
  - "Maximum update depth exceeded" error: Check useEffect dependencies
---

## 2024-01-29 - US-006 Swipe-to-delete on sidebar note items
- What was implemented: Swipe gesture for deleting notes
- Files changed:
  - components/layout/Sidebar/NoteItem.tsx
  - components/layout/Sidebar/NoteItem.css
- **Learnings for future iterations:**
  - Use useRef for swipe offset to avoid stale closure in event handlers
  - Support both touch (onTouchStart/Move/End) and mouse (onMouseDown/Move/Up)
  - Delete threshold: 50% of item width
  - Delete button position: Fixed to right edge of parent, not sliding with item
  - Use GlassButton with variant="danger" for delete button
---

## 2024-01-29 - US-007 ListView with responsive grid
- What was implemented: Flexbox grid for note cards
- Files changed:
  - components/views/ListView/ListView.tsx
  - components/views/ListView/ListView.css
  - components/layout/Sidebar/NoteItemFull.tsx (new component)
- **Learnings for future iterations:**
  - Use flexbox with flex-wrap, not complex media queries
  - NoteItemFull: No swipe delete, full card with preview
  - Date metadata at bottom: Use flexbox with margin-top: auto
---

## 2024-01-29 - US-008 Search with yellow shadow highlighting
- What was implemented: Search filtering and text highlighting
- Files changed:
  - utils/highlightText.tsx
  - styles/utilities.css (.search-highlight class)
  - components/views/ListView/ListView.tsx
  - components/layout/Sidebar/CollapsibleSidebar.tsx
- **Learnings for future iterations:**
  - Highlight style: Yellow shadow underneath text, NOT block background
  - Use box-shadow: `0 2px 0px 0px rgba(255, 235, 59, 0.5)`
  - Group titles show search query with highlighting when searching
---

## 2024-01-29 - US-009 Keyboard shortcuts system
- What was implemented: Reusable keyboard shortcuts hook with platform support
- Files changed:
  - utils/keyboardShortcuts.ts (main hook)
  - utils/noteActions.ts (pure functions for actions)
  - hooks/useGlobalShortcuts.ts (Cmd+N, Cmd+S)
  - hooks/useEditorShortcuts.ts (ESC)
  - app/page.tsx (register global shortcuts)
  - components/views/EditorView/EditorView.tsx (register editor shortcuts)
- **Learnings for future iterations:**
  - Use capture phase (`{ capture: true }`) to prevent browser defaults
  - Use stopImmediatePropagation() in addition to preventDefault()
  - Platform detection: isMac() checks navigator.platform
  - "cmd+n" automatically maps to Ctrl on Windows/Linux
  - Don't need separate shortcuts for cmd and ctrl
  - Keep business logic in pure functions (noteActions.ts), not hooks
---

## 2024-01-29 - US-010 Editable note title in TopBar
- What was implemented: Click-to-edit title in TopBar
- Files changed:
  - components/layout/TopBar/TopBar.tsx
  - components/layout/TopBar/TopBar.css
- **Learnings for future iterations:**
  - Use isEditing state to toggle between span and input
  - Save on blur and Enter key
  - Cancel on Escape key (restore original value)
  - Update both page title and first block content
---

## 2026-01-29 - Block Editor Foundation Plan
- **Goal**: Build intuitive block-based editor with natural UX
- **Key Decisions**:
  - Storage: Hybrid (IndexedDB + markdown export)
  - Approach: Adapt NewPage-main's useBlockEditor hook to Zustand
  - Libraries: Ask before installing any new packages
- **Implementation Order**:
  1. US-016: Unified block menu config (single source of truth)
  2. US-017: Block editor core with useBlockEditor hook
  3. US-018: Custom blue caret with glow animation
  4. US-019: Editable blocks with contentEditable
  5. US-020: Slash menu with glass styling
  6. US-021: Contextual bottom bar
  7. US-022: Arrow key navigation
  8. US-023: Text formatting shortcuts
  9. US-024: Markdown export
- **Files to Create**:
  - config/blockMenuConfig.ts (menu items, conditionals)
  - hooks/useBlockEditor.ts (block CRUD)
  - hooks/useBlockNavigation.ts (arrow keys)
  - components/ui/CustomCaret/CustomCaret.tsx
  - components/blocks/EditableBlock.tsx
  - utils/markdownExport.ts
- **Architecture**:
  - blockMenuConfig.ts -> SlashMenu + BottomToolbar (synchronized)
  - useBlockEditor -> editorStore (Zustand)
  - EditableBlock -> CustomCaret (visual)
---

## 2026-01-29 - US-016 Unified block menu config (single source of truth)
- What was implemented: Created config/blockMenuConfig.ts as single source of truth for both slash menu and bottom bar
- Files changed:
  - config/blockMenuConfig.ts (NEW - all menu items with conditionals)
- **Learnings for future iterations:**
  - Single config file ensures menus stay synchronized automatically
  - Conditional functions (showInSlashMenu, showInBottomBar) receive selection state for context-aware filtering
  - Helper functions (getSlashMenuItems, getBottomBarItems) make it easy to filter by context
  - Icons can be strings (for simple blocks) or React components (for formatting icons)
  - Categories: 'blocks' (insertable), 'format' (text formatting), 'actions' (future: block actions)
---

## 2026-01-29 - US-017 Block editor core with useBlockEditor hook
- What was implemented: Created hooks/useBlockEditor.ts adapted from NewPage-main, simplified for Zustand integration
- Files changed:
  - hooks/useBlockEditor.ts (NEW - block CRUD operations)
- **Learnings for future iterations:**
  - Zustand's setBlocks expects Block[] directly, not a function - use getState() to read current state
  - Simplified version removes groups/tabs/indentation complexity from NewPage-main (can add later if needed)
  - Hook integrates seamlessly with editorStore - uses store methods directly
  - Focus management handled in hook (setFocusedBlock, setCaretPosition)
  - Helper methods: moveBlockUp, moveBlockDown, duplicateBlock for common operations
---

## 2026-01-29 - US-018 Custom blue caret with glow animation
- What was implemented: Created CustomCaret component with blue glow effect and blink animation
- Files changed:
  - components/ui/CustomCaret/CustomCaret.tsx (NEW)
  - components/ui/CustomCaret/CustomCaret.css (NEW)
  - styles/caret.css (NEW - selection styles and native caret hiding)
  - app/globals.css (MODIFY - added caret.css import)
- **Learnings for future iterations:**
  - CustomCaret tracks selection position using Selection API and getBoundingClientRect()
  - Position calculation accounts for line-height and font-size for proper vertical centering
  - Empty block handling: centers caret when no text is present
  - Blink animation uses opacity fade (0.3 to 1.0) not on/off for smoother effect
  - Blue glow uses box-shadow with rgba(0, 122, 255, ...) for Apple-like appearance
  - Native caret hidden with caret-color: transparent in contentEditable elements
  - Selection color set to blue (#007AFF) using ::selection pseudo-element
---

## 2026-01-29 - US-019 Editable blocks with contentEditable
- What was implemented: Created EditableBlock base component and updated Paragraph/Heading to use it
- Files changed:
  - components/blocks/EditableBlock.tsx (NEW)
  - components/blocks/EditableBlock.css (NEW)
  - components/blocks/Paragraph/Paragraph.tsx (MODIFY - uses EditableBlock)
  - components/blocks/Heading/Heading.tsx (MODIFY - uses EditableBlock)
- **Learnings for future iterations:**
  - contentEditable requires controlled content with state sync to block.content
  - Auto-height adjustment using scrollHeight for multi-line text
  - Paste handler strips formatting and inserts plain text only
  - Enter key creates new block via onCreateBlockAfter callback or addBlock()
  - Backspace on empty block deletes via deleteBlock()
  - Slash key (/) triggers onOpenSlashMenu callback with cursor position
  - CustomCaret integrated and shows when block is focused
  - Click handling positions caret at nearest text position
  - Tab key placeholder for future indent/outdent feature
---

## 2026-01-29 - US-020 Slash menu with glass styling
- What was implemented: Enhanced SlashMenu with glass morphism styling, search, keyboard navigation
- Files changed:
  - components/menus/SlashMenu/SlashMenu.tsx (MODIFY - uses blockMenuConfig, glass styling)
  - components/menus/SlashMenu/SlashMenu.css (MODIFY - glass morphism styles)
  - hooks/useSlashMenu.ts (NEW - menu state management)
- **Learnings for future iterations:**
  - Glass styling uses var(--glass-bg-light), var(--glass-backdrop-filter), var(--glass-border-light)
  - Absolute positioning (not fixed) - follows cursor position, no backdrop overlay
  - Items filtered from blockMenuConfig using getSlashMenuItems()
  - Search filters by label and slashCommands
  - Keyboard navigation: Arrow keys cycle selection, Enter selects, Escape closes
  - Icon rendering handles both string icons and React component icons
  - Click outside closes menu via mousedown event listener
---

## 2026-01-29 - US-021 Contextual bottom bar
- What was implemented: Updated BottomToolbar to show different items based on selection state
- Files changed:
  - components/layout/BottomToolbar/BottomToolbar.tsx (MODIFY - uses blockMenuConfig, contextual display)
  - components/ui/GlassButton/GlassButton.tsx (MODIFY - accepts string icons)
  - components/ui/GlassButton/GlassButton.css (MODIFY - added icon-text styling)
- **Learnings for future iterations:**
  - Contextual display: block items when selection?.type !== 'text', format items when selection?.type === 'text'
  - Items filtered from blockMenuConfig using getBottomBarBlockItems() and getBottomBarFormatItems()
  - GlassButton updated to accept string icons (for block type buttons) or React components (for formatting icons)
  - Block selection triggers addBlock() with appropriate blockType
  - Format selection placeholder (will be implemented in US-023)
  - Smooth transition between states handled by React re-render
---

## 2026-01-29 - US-022 Arrow key navigation between blocks
- What was implemented: Created useBlockNavigation hook for natural document navigation
- Files changed:
  - hooks/useBlockNavigation.ts (NEW)
  - components/blocks/EditableBlock.tsx (MODIFY - integrated navigation hook)
- **Learnings for future iterations:**
  - Arrow Up/Left at cursor position 0 moves to previous block (caret at end)
  - Arrow Down/Right at end of content moves to next block (caret at start)
  - Uses querySelector with data-block-id attribute to find block elements
  - Focus management with proper caret positioning using Selection API
  - setTimeout(0) needed for caret positioning to work after focus()
  - Returns boolean to indicate if navigation was handled (prevents default behavior)
---

## 2026-01-29 - US-023 Text formatting with keyboard shortcuts
- What was implemented: Formatting shortcuts and utilities for inline text formatting
- Files changed:
  - utils/formatText.ts (NEW - apply/remove/toggle formatting)
  - utils/renderFormattedText.tsx (NEW - render formatted text visually)
  - types/block.ts (MODIFY - updated InlineFormat type)
  - components/blocks/EditableBlock.tsx (MODIFY - handles cmd+b/i/u/e shortcuts)
  - components/layout/BottomToolbar/BottomToolbar.tsx (MODIFY - formatting buttons functional)
  - hooks/useEditorShortcuts.ts (MODIFY - removed formatting shortcuts, handled in EditableBlock)
- **Learnings for future iterations:**
  - Formatting shortcuts must be handled in EditableBlock (contentEditable), not global shortcuts hook
  - Formatting stored as array of { type, start, end, data? } objects
  - Position calculation uses Range API: cloneRange, selectNodeContents, toString().length
  - toggleFormat() checks if format exists, removes if present, adds if absent
  - Formatting positions need adjustment when content changes (insert/delete)
  - Visual rendering of formatted text uses renderFormattedText() utility (future: integrate into EditableBlock display)
  - BottomToolbar formatting buttons work when text is selected
---

## 2026-01-29 - US-024 Markdown export
- What was implemented: Created markdown export utility for converting pages to markdown files
- Files changed:
  - utils/markdownExport.ts (NEW - serialize blocks to markdown, download function)
- **Learnings for future iterations:**
  - Headings: # ## ### etc. based on block.props.level
  - Lists: - (unordered), 1. (ordered), - [ ] (checklist)
  - Code blocks: ```language with language from block.props.language
  - Images: ![alt](src) format
  - Inline formatting: **bold**, *italic*, `code`, [link](url), ~~strikethrough~~
  - applyInlineFormats() handles nested formatting by building segments array
  - downloadPageAsMarkdown() creates Blob and triggers download with page title as filename
  - Export preserves block structure and formatting
---


